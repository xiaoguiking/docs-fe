# 前端性能优化



## 职业发展问题
:::details 

```
- 前端工程化
    - 编译打包发布流程
    - 物料中心 
    - 组件化

- 体验领域
  - 性能优化方向
```
:::

## 一、前端性能优化方法论

### 1.1 从页面输入到页面加载的全过程

- 客户端发起请求阶段
  - 本地缓存
    - 强缓存 (根据请求头的expires 和 cache-control 判断是否命中客户端缓存)
    - 协商缓存 (浏览器先发送一个请求到服务器通过last-modified和etag验证资源是否命中客户端缓存)
  -  DNS查询
     -  配置DNS查询走缓存
  -  Http 请求阻塞
- 服务端数据请求处理阶段
  - 是否增加了Gzip压缩
  - CDN请求
  - 页面重定向
    - 服务端的302重定向
    - META标签实现的重定向
    - window.location实现的重定向
- 客户端页面渲染阶段
  - DOM树构建过程
  - CSSOM树构成生成过程
  - 重排和重绘过程

### 1.2 移动端M站性能优化

- 项目立项
- 性能诊断优化
  - 本地缓存减少请求资源数
  - 运维对静态资源配置合理的资源过期时间，实现静态资源的强缓存方案 
  -
- 重点难点
  - 1. 列表页改单页面应用
    - 1. 列表页主要用来展示分类下的列表信息，根据用户的筛选项，将搜索结果展示给用户
    - 2. 爬虫SEO, 页面访问头是爬虫就走服务端模版，个人用户就走单页面应用
  - 2. 弱网下的优化
    - 1. 页面请求合并处理
    - 2. 小图标使用base64处理，内嵌在页面中
    - 3. 针对弱网，不自动加载请求，使用展位图
  - 主要是由点到面的处理，先局部后整体

### 1.3 首屏时间指标采集办法

- 手动采集
  - 埋点
- 通用采集
  - 使用配置类型代码处理
- 服务端模版下的采集办法
  - HTTP请求
  - HTML文档加载解析完成
    - 首屏时间点 DOMContentLoad
      - 当页面中的html加载解析完成之后DOMContentLoaded事件触发
      - 首屏时间 = DOMContentLoad时间 = domContentLoadEventEd - fetchStart时间
  - 加载样式和脚本文件
  - 完成页面渲染
- 单页面应用业务下的采集办法
  - 在用户进入页面，使用MutationObserver监控DOM元素，当DOM元素发生变化，程序会标记元素的元素记录时间点和分数，存储到数组中


### 1.4 白屏、卡顿等指标采集办法
 
> 白屏:
> 从输入页面内容回车包括刷新、跳转等方式后到页面开始出现的第一个字符的时间

> 白屏时间 = 页面开始展示时间 - 开始请求时间点
> 白屏时间FP = domLoading - navigationStart

> 卡顿指标采集：
> FPS 每秒显示帧数


为什么会出现APP白屏时间过长或卡顿问题 ？

```
一般WebView初始化慢、DNS解析慢、视图树过于复杂和主线程被阻塞等都会导致问题出现
大多数白屏和卡顿都和网络环境有关
```



> 浏览器页面加载过程

```
1. 客户端发起请求
2. 下载html、css、js资源
3. 解析js执行
4. js请求数据
5. 客户端解析DOM并渲染
6. 下载渲染图片
7. 完成渲染整体
```

> APP 下的页面加载过程

```
1. 初始化WebView  
2. 客户端发起请求
3. 下载html及JS/CSS资源
4. 解析JS执行
5. JS请求数据
6. 服务端处理并返回数据
7. 客户端解析DOM并渲染
8. 下载渲染图片
9. 完成整体渲染
```



## 二、指标采集上报优化手段

### 性能SDK以及上报策略设计

1.为了进行首屏、白屏、卡顿的指标采集

```
封装Perf API
调用FMP、FP、Block、ExtensionAPI完成

调用window api 接口需要处理环境兼容
```


### 前端性能平台搭建

- 平台层
  - React Antd Antv 
- 数据接入层
  - NodeJs Node-sechdule Node-mailer 
- 数据计算层
  - Kafka Spark hive HDFS
- 存储层 
  - Mysql Mongodb

> 性能平台架构设计流程

> 1. 数据处理后台

```
1. 客户端借助SDK上报性能数据指标，使用Nodejs利用Controller层对数据做处理，将SDK上报的数据通过URL解析成key-value格式的数据进行空数据删除，异常数据舍弃等操作 

2. 对Kafka中的数据进行清洗和计算(重复数据、缺失数据、错误数据)

3. 使用Spark做数据计算，为可视化数据做准备(首屏时间的分步计算、 秒开率计算首屏时间小于等于1秒的数据占比 页面瀑布流时间计算)

4. mysql存储用户关注的信息登录， mongodb存入性能数据

```

> 2. 前端数据可视化展示前台

```
1. 性能可视图前端展示
2. 监控预警问题，借助Node-sechdule做调度，和定时任务的处理，使用node-mailer邮件报警
```

```
最重要的指标： 秒开率、首屏时间、白屏时间、卡顿时间
```

### 监控预警以及问题诊断

- 监控预警
  - 准备预警数据
    - 数据清洗后，一个分支使用Spark计算
    - 使用Flink做实时数据计算
    - 对数据分层，标记预警数据
  -  数据拉取
    - 使用Node-schedule定时任务将预警数据通过Nodejs拉取数据到MongoDB预警表中
  -  数据预警
     -  根据预警数据的不同，预警内容分级别预警给开发关注者



## 三、Hybrid下的进阶优化 

## 四、性能优化数据评估预警

## 五、一线大厂性能优化体系演进